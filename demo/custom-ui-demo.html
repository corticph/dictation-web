<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Custom UI Demo</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css"
    />
  </head>
  <body>
    <header>
      <nav><a href="index.html">‚Üê Back to Demo Index</a></nav>
      <h1>Custom UI Demo</h1>
      <p>Set your access token in the code to start the demo.</p>
    </header>

    <main>
      <!-- Hidden Corti Dictation component -->
      <corti-dictation style="display: none"></corti-dictation>

      <!-- Custom UI -->
      <div role="group">
        <button id="recordingButton">Start</button>
        <select id="micSelector"></select>
        <select id="languageSelector"></select>
      </div>

      <progress
        id="progress"
        value="0"
        max="1"
      ></progress>

      <textarea
        id="transcriptArea"
        placeholder="Transcript will appear here..."
      ></textarea>
    </main>

    <script type="module">
      // Import the Corti Dictation SDK
      // import "@corti/dictation-web";
      import "../dist/bundle.js";

      window.addEventListener("DOMContentLoaded", () => {
        const dictation = document.querySelector("corti-dictation");
        const recordingButton = document.getElementById("recordingButton");
        const micSelector = document.getElementById("micSelector");
        const languageSelector = document.getElementById("languageSelector");
        const transcriptArea = document.getElementById("transcriptArea");
        const progress = document.getElementById("progress");

        // Set your access token
        dictation.setAccessToken("YOUR_ACCESS_TOKEN");

        const userLocale = navigator.language || "en";
        let languageDisplayNames;
        try {
          languageDisplayNames = new Intl.DisplayNames([userLocale], {
            type: "language",
          });
        } catch {
          languageDisplayNames = null;
        }

        const getLanguageName = (code) =>
          languageDisplayNames?.of(code) || code;

        function populateDevices(devices = [], selectedDevice) {
          if (!devices.length) return;

          micSelector.innerHTML = "";
          devices.forEach((device) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.textContent = device.label || `Device ${device.deviceId}`;
            micSelector.appendChild(option);
          });

          if (selectedDevice) {
            micSelector.value = selectedDevice.deviceId;
          }
        }

        function populateLanguages(languages = [], selectedLanguage) {
          if (!languages.length) return;

          languageSelector.innerHTML = "";
          languages.forEach((language) => {
            const option = document.createElement("option");
            option.value = language;
            option.textContent = getLanguageName(language);
            languageSelector.appendChild(option);
          });

          if (selectedLanguage) {
            languageSelector.value = selectedLanguage;
          }
        }

        dictation.addEventListener("ready", () => {
          populateDevices(dictation.devices, dictation.selectedDevice);
          populateLanguages(
            dictation.languagesSupported,
            dictation.dictationConfig?.primaryLanguage
          );
        });

        dictation.addEventListener("recording-state-changed", (e) => {
          const { state } = e.detail;

          const labels = {
            recording: "Stop",
            stopped: "Start",
            initializing: "Initializing...",
            stopping: "Stopping...",
          };

          recordingButton.textContent = labels[state] || "Start";
          const busy = state === "initializing" || state === "stopping";
          recordingButton.toggleAttribute("aria-busy", busy);
          recordingButton.disabled = busy;
        });

        dictation.addEventListener("recording-devices-changed", (e) => {
          const { devices, selectedDevice } = e.detail;
          populateDevices(devices, selectedDevice);
        });

        dictation.addEventListener("transcript", (e) => {
          const { text } = e.detail.data;
          transcriptArea.value += text + " ";
          transcriptArea.scrollTop = transcriptArea.scrollHeight;
        });

        dictation.addEventListener("audio-level-changed", (e) => {
          progress.value = e.detail.audioLevel;
        });

        dictation.addEventListener("error", (e) => {
          console.error("Corti dictation error:", e.detail);
        });

        recordingButton.addEventListener("click", () => {
          dictation.toggleRecording();
        });

        micSelector.addEventListener("change", () => {
          const selected = dictation.devices.find(
            (device) => device.deviceId === micSelector.value
          );
          if (selected) {
            dictation.selectedDevice = selected;
          }
        });

        languageSelector.addEventListener("change", () => {
          if (!dictation.dictationConfig) {
            dictation.dictationConfig = {};
          }
          dictation.dictationConfig.primaryLanguage = languageSelector.value;
        });
      });
    </script>
  </body>
</html>
